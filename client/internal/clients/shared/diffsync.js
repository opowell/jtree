!function(t){if("object"==typeof exports&&"undefined"!=typeof module)module.exports=t();else if("function"==typeof define&&define.amd)define([],t);else{var e;e="undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:this,e.diffsync=t()}}(function(){return function t(e,r,n){function i(s,a){if(!r[s]){if(!e[s]){var c="function"==typeof require&&require;if(!a&&c)return c(s,!0);if(o)return o(s,!0);var l=new Error("Cannot find module '"+s+"'");throw l.code="MODULE_NOT_FOUND",l}var f=r[s]={exports:{}};e[s][0].call(f.exports,function(t){var r=e[s][1][t];return i(r?r:t)},f,f.exports,t,e,r,n)}return r[s].exports}for(var o="function"==typeof require&&require,s=0;s<n.length;s++)i(n[s]);return i}({1:[function(t,e,r){function n(){this._events=this._events||{},this._maxListeners=this._maxListeners||void 0}function i(t){return"function"==typeof t}function o(t){return"number"==typeof t}function s(t){return"object"==typeof t&&null!==t}function a(t){return void 0===t}e.exports=n,n.EventEmitter=n,n.prototype._events=void 0,n.prototype._maxListeners=void 0,n.defaultMaxListeners=10,n.prototype.setMaxListeners=function(t){if(!o(t)||t<0||isNaN(t))throw TypeError("n must be a positive number");return this._maxListeners=t,this},n.prototype.emit=function(t){var e,r,n,o,c,l;if(this._events||(this._events={}),"error"===t&&(!this._events.error||s(this._events.error)&&!this._events.error.length)){if(e=arguments[1],e instanceof Error)throw e;var f=new Error('Uncaught, unspecified "error" event. ('+e+")");throw f.context=e,f}if(r=this._events[t],a(r))return!1;if(i(r))switch(arguments.length){case 1:r.call(this);break;case 2:r.call(this,arguments[1]);break;case 3:r.call(this,arguments[1],arguments[2]);break;default:o=Array.prototype.slice.call(arguments,1),r.apply(this,o)}else if(s(r))for(o=Array.prototype.slice.call(arguments,1),l=r.slice(),n=l.length,c=0;c<n;c++)l[c].apply(this,o);return!0},n.prototype.addListener=function(t,e){var r;if(!i(e))throw TypeError("listener must be a function");return this._events||(this._events={}),this._events.newListener&&this.emit("newListener",t,i(e.listener)?e.listener:e),this._events[t]?s(this._events[t])?this._events[t].push(e):this._events[t]=[this._events[t],e]:this._events[t]=e,s(this._events[t])&&!this._events[t].warned&&(r=a(this._maxListeners)?n.defaultMaxListeners:this._maxListeners,r&&r>0&&this._events[t].length>r&&(this._events[t].warned=!0,console.error("(node) warning: possible EventEmitter memory leak detected. %d listeners added. Use emitter.setMaxListeners() to increase limit.",this._events[t].length),"function"==typeof console.trace&&console.trace())),this},n.prototype.on=n.prototype.addListener,n.prototype.once=function(t,e){function r(){this.removeListener(t,r),n||(n=!0,e.apply(this,arguments))}if(!i(e))throw TypeError("listener must be a function");var n=!1;return r.listener=e,this.on(t,r),this},n.prototype.removeListener=function(t,e){var r,n,o,a;if(!i(e))throw TypeError("listener must be a function");if(!this._events||!this._events[t])return this;if(r=this._events[t],o=r.length,n=-1,r===e||i(r.listener)&&r.listener===e)delete this._events[t],this._events.removeListener&&this.emit("removeListener",t,e);else if(s(r)){for(a=o;a-- >0;)if(r[a]===e||r[a].listener&&r[a].listener===e){n=a;break}if(n<0)return this;1===r.length?(r.length=0,delete this._events[t]):r.splice(n,1),this._events.removeListener&&this.emit("removeListener",t,e)}return this},n.prototype.removeAllListeners=function(t){var e,r;if(!this._events)return this;if(!this._events.removeListener)return 0===arguments.length?this._events={}:this._events[t]&&delete this._events[t],this;if(0===arguments.length){for(e in this._events)"removeListener"!==e&&this.removeAllListeners(e);return this.removeAllListeners("removeListener"),this._events={},this}if(r=this._events[t],i(r))this.removeListener(t,r);else if(r)for(;r.length;)this.removeListener(t,r[r.length-1]);return delete this._events[t],this},n.prototype.listeners=function(t){var e;return e=this._events&&this._events[t]?i(this._events[t])?[this._events[t]]:this._events[t].slice():[]},n.prototype.listenerCount=function(t){if(this._events){var e=this._events[t];if(i(e))return 1;if(e)return e.length}return 0},n.listenerCount=function(t,e){return t.listenerCount(e)}},{}],2:[function(t,e,r){e.exports={Client:t("./src/client"),Server:t("./src/server"),COMMANDS:t("./src/commands"),InMemoryDataAdapter:t("./src/adapter")}},{"./src/adapter":42,"./src/client":43,"./src/commands":44,"./src/server":45}],3:[function(t,e,r){var n=t("../pipe").Pipe,i=function(){};i.prototype.setResult=function(t){return this.result=t,this.hasResult=!0,this},i.prototype.exit=function(){return this.exiting=!0,this},i.prototype.switchTo=function(t,e){return"string"==typeof t||t instanceof n?this.nextPipe=t:(this.next=t,e&&(this.nextPipe=e)),this},i.prototype.push=function(t,e){return t.parent=this,"undefined"!=typeof e&&(t.childName=e),t.root=this.root||this,t.options=t.options||this.options,this.children?(this.children[this.children.length-1].next=t,this.children.push(t)):(this.children=[t],this.nextAfterChildren=this.next||null,this.next=t),t.next=this,this},r.Context=i},{"../pipe":17}],4:[function(t,e,r){var n=t("./context").Context,i=t("../date-reviver"),o=function(t,e){this.left=t,this.right=e,this.pipe="diff"};o.prototype=new n,o.prototype.setResult=function(t){if(this.options.cloneDiffValues){var e="function"==typeof this.options.cloneDiffValues?this.options.cloneDiffValues:function(t){return JSON.parse(JSON.stringify(t),i)};"object"==typeof t[0]&&(t[0]=e(t[0])),"object"==typeof t[1]&&(t[1]=e(t[1]))}return n.prototype.setResult.apply(this,arguments)},r.DiffContext=o},{"../date-reviver":7,"./context":3}],5:[function(t,e,r){var n=t("./context").Context,i=function(t,e){this.left=t,this.delta=e,this.pipe="patch"};i.prototype=new n,r.PatchContext=i},{"./context":3}],6:[function(t,e,r){var n=t("./context").Context,i=function(t){this.delta=t,this.pipe="reverse"};i.prototype=new n,r.ReverseContext=i},{"./context":3}],7:[function(t,e,r){e.exports=function(t,e){var r;return"string"==typeof e&&(r=/^(\d{4})-(\d{2})-(\d{2})T(\d{2}):(\d{2}):(\d{2})(?:\.(\d*))?(Z|([+\-])(\d{2}):(\d{2}))$/.exec(e))?new Date(Date.UTC(+r[1],+r[2]-1,+r[3],+r[4],+r[5],+r[6],+(r[7]||0))):e}},{}],8:[function(t,e,r){var n=t("./processor").Processor,i=t("./pipe").Pipe,o=t("./contexts/diff").DiffContext,s=t("./contexts/patch").PatchContext,a=t("./contexts/reverse").ReverseContext,c=t("./filters/trivial"),l=t("./filters/nested"),f=t("./filters/arrays"),u=t("./filters/dates"),h=t("./filters/texts"),p=function(t){this.processor=new n(t),this.processor.pipe(new i("diff").append(l.collectChildrenDiffFilter,c.diffFilter,u.diffFilter,h.diffFilter,l.objectsDiffFilter,f.diffFilter).shouldHaveResult()),this.processor.pipe(new i("patch").append(l.collectChildrenPatchFilter,f.collectChildrenPatchFilter,c.patchFilter,h.patchFilter,l.patchFilter,f.patchFilter).shouldHaveResult()),this.processor.pipe(new i("reverse").append(l.collectChildrenReverseFilter,f.collectChildrenReverseFilter,c.reverseFilter,h.reverseFilter,l.reverseFilter,f.reverseFilter).shouldHaveResult())};p.prototype.options=function(){return this.processor.options.apply(this.processor,arguments)},p.prototype.diff=function(t,e){return this.processor.process(new o(t,e))},p.prototype.patch=function(t,e){return this.processor.process(new s(t,e))},p.prototype.reverse=function(t){return this.processor.process(new a(t))},p.prototype.unpatch=function(t,e){return this.patch(t,this.reverse(e))},r.DiffPatcher=p},{"./contexts/diff":4,"./contexts/patch":5,"./contexts/reverse":6,"./filters/arrays":10,"./filters/dates":11,"./filters/nested":13,"./filters/texts":14,"./filters/trivial":15,"./pipe":17,"./processor":18}],9:[function(t,e,r){r.isBrowser="undefined"!=typeof window},{}],10:[function(t,e,r){function n(t,e,r,n){for(var i=0;i<r;i++)for(var o=t[i],s=0;s<n;s++){var a=e[s];if(o===a)return!0}}function i(t,e,r,n,i){var o=t[r],s=e[n];if(o===s)return!0;if("object"!=typeof o||"object"!=typeof s)return!1;var a=i.objectHash;if(!a)return i.matchByPosition&&r===n;var c,l;return"number"==typeof r?(i.hashCache1=i.hashCache1||[],c=i.hashCache1[r],"undefined"==typeof c&&(i.hashCache1[r]=c=a(o,r))):c=a(o),"undefined"!=typeof c&&("number"==typeof n?(i.hashCache2=i.hashCache2||[],l=i.hashCache2[n],"undefined"==typeof l&&(i.hashCache2[n]=l=a(s,n))):l=a(s),"undefined"!=typeof l&&c===l)}var o=t("../contexts/diff").DiffContext,s=t("../contexts/patch").PatchContext,a=t("../contexts/reverse").ReverseContext,c=t("./lcs"),l=3,f="function"==typeof Array.isArray?Array.isArray:function(t){return t instanceof Array},u="function"==typeof Array.prototype.indexOf?function(t,e){return t.indexOf(e)}:function(t,e){for(var r=t.length,n=0;n<r;n++)if(t[n]===e)return n;return-1},h=function(t){if(t.leftIsArray){var e,r,s,a,f={objectHash:t.options&&t.options.objectHash,matchByPosition:t.options&&t.options.matchByPosition},h=0,p=0,d=t.left,v=t.right,y=d.length,g=v.length;for(y>0&&g>0&&!f.objectHash&&"boolean"!=typeof f.matchByPosition&&(f.matchByPosition=!n(d,v,y,g));h<y&&h<g&&i(d,v,h,h,f);)e=h,a=new o(t.left[e],t.right[e]),t.push(a,e),h++;for(;p+h<y&&p+h<g&&i(d,v,y-1-p,g-1-p,f);)r=y-1-p,s=g-1-p,a=new o(t.left[r],t.right[s]),t.push(a,s),p++;var m;if(h+p===y){if(y===g)return void t.setResult(void 0).exit();for(m=m||{_t:"a"},e=h;e<g-p;e++)m[e]=[v[e]];return void t.setResult(m).exit()}if(h+p===g){for(m=m||{_t:"a"},e=h;e<y-p;e++)m["_"+e]=[d[e],0,0];return void t.setResult(m).exit()}delete f.hashCache1,delete f.hashCache2;var x=d.slice(h,y-p),w=v.slice(h,g-p),_=c.get(x,w,i,f),b=[];for(m=m||{_t:"a"},e=h;e<y-p;e++)u(_.indices1,e-h)<0&&(m["_"+e]=[d[e],0,0],b.push(e));var C=!0;t.options&&t.options.arrays&&t.options.arrays.detectMove===!1&&(C=!1);var j=!1;t.options&&t.options.arrays&&t.options.arrays.includeValueOnMove&&(j=!0);var R=b.length;for(e=h;e<g-p;e++){var E=u(_.indices2,e-h);if(E<0){var F=!1;if(C&&R>0)for(var N=0;N<R;N++)if(r=b[N],i(x,w,r-h,e-h,f)){m["_"+r].splice(1,2,e,l),j||(m["_"+r][0]=""),s=e,a=new o(t.left[r],t.right[s]),t.push(a,s),b.splice(N,1),F=!0;break}F||(m[e]=[v[e]])}else r=_.indices1[E]+h,s=_.indices2[E]+h,a=new o(t.left[r],t.right[s]),t.push(a,s)}t.setResult(m).exit()}};h.filterName="arrays";var p={numerically:function(t,e){return t-e},numericallyBy:function(t){return function(e,r){return e[t]-r[t]}}},d=function(t){if(t.nested&&"a"===t.delta._t){var e,r,n=t.delta,i=t.left,o=[],a=[],c=[];for(e in n)if("_t"!==e)if("_"===e[0]){if(0!==n[e][2]&&n[e][2]!==l)throw new Error("only removal or move can be applied at original array indices, invalid diff type: "+n[e][2]);o.push(parseInt(e.slice(1),10))}else 1===n[e].length?a.push({index:parseInt(e,10),value:n[e][0]}):c.push({index:parseInt(e,10),delta:n[e]});for(o=o.sort(p.numerically),e=o.length-1;e>=0;e--){r=o[e];var f=n["_"+r],u=i.splice(r,1)[0];f[2]===l&&a.push({index:f[1],value:u})}a=a.sort(p.numericallyBy("index"));var h=a.length;for(e=0;e<h;e++){var d=a[e];i.splice(d.index,0,d.value)}var v,y=c.length;if(y>0)for(e=0;e<y;e++){var g=c[e];v=new s(t.left[g.index],g.delta),t.push(v,g.index)}return t.children?void t.exit():void t.setResult(t.left).exit()}};d.filterName="arrays";var v=function(t){if(t&&t.children&&"a"===t.delta._t){for(var e,r=t.children.length,n=0;n<r;n++)e=t.children[n],t.left[e.childName]=e.result;t.setResult(t.left).exit()}};v.filterName="arraysCollectChildren";var y=function(t){if(!t.nested)return void(t.delta[2]===l&&(t.newName="_"+t.delta[1],t.setResult([t.delta[0],parseInt(t.childName.substr(1),10),l]).exit()));if("a"===t.delta._t){var e,r;for(e in t.delta)"_t"!==e&&(r=new a(t.delta[e]),t.push(r,e));t.exit()}};y.filterName="arrays";var g=function(t,e,r){if("string"==typeof e&&"_"===e[0])return parseInt(e.substr(1),10);if(f(r)&&0===r[2])return"_"+e;var n=+e;for(var i in t){var o=t[i];if(f(o))if(o[2]===l){var s=parseInt(i.substr(1),10),a=o[1];if(a===+e)return s;s<=n&&a>n?n++:s>=n&&a<n&&n--}else if(0===o[2]){var c=parseInt(i.substr(1),10);c<=n&&n++}else 1===o.length&&i<=n&&n--}return n},m=function(t){if(t&&t.children&&"a"===t.delta._t){for(var e,r=t.children.length,n={_t:"a"},i=0;i<r;i++){e=t.children[i];var o=e.newName;"undefined"==typeof o&&(o=g(t.delta,e.childName,e.result)),n[o]!==e.result&&(n[o]=e.result)}t.setResult(n).exit()}};m.filterName="arraysCollectChildren",r.diffFilter=h,r.patchFilter=d,r.collectChildrenPatchFilter=v,r.reverseFilter=y,r.collectChildrenReverseFilter=m},{"../contexts/diff":4,"../contexts/patch":5,"../contexts/reverse":6,"./lcs":12}],11:[function(t,e,r){var n=function(t){t.left instanceof Date?(t.right instanceof Date?t.left.getTime()!==t.right.getTime()?t.setResult([t.left,t.right]):t.setResult(void 0):t.setResult([t.left,t.right]),t.exit()):t.right instanceof Date&&t.setResult([t.left,t.right]).exit()};n.filterName="dates",r.diffFilter=n},{}],12:[function(t,e,r){var n=function(t,e,r,n){return t[r]===e[n]},i=function(t,e,r,n){var i,o,s=t.length,a=e.length,c=[s+1];for(i=0;i<s+1;i++)for(c[i]=[a+1],o=0;o<a+1;o++)c[i][o]=0;for(c.match=r,i=1;i<s+1;i++)for(o=1;o<a+1;o++)r(t,e,i-1,o-1,n)?c[i][o]=c[i-1][o-1]+1:c[i][o]=Math.max(c[i-1][o],c[i][o-1]);return c},o=function(t,e,r,n,i,s){if(0===n||0===i)return{sequence:[],indices1:[],indices2:[]};if(t.match(e,r,n-1,i-1,s)){var a=o(t,e,r,n-1,i-1,s);return a.sequence.push(e[n-1]),a.indices1.push(n-1),a.indices2.push(i-1),a}return t[n][i-1]>t[n-1][i]?o(t,e,r,n,i-1,s):o(t,e,r,n-1,i,s)},s=function(t,e,r,s){s=s||{};var a=i(t,e,r||n,s),c=o(a,t,e,t.length,e.length,s);return"string"==typeof t&&"string"==typeof e&&(c.sequence=c.sequence.join("")),c};r.get=s},{}],13:[function(t,e,r){var n=t("../contexts/diff").DiffContext,i=t("../contexts/patch").PatchContext,o=t("../contexts/reverse").ReverseContext,s=function(t){if(t&&t.children){for(var e,r=t.children.length,n=t.result,i=0;i<r;i++)e=t.children[i],"undefined"!=typeof e.result&&(n=n||{},n[e.childName]=e.result);n&&t.leftIsArray&&(n._t="a"),t.setResult(n).exit()}};s.filterName="collectChildren";var a=function(t){if(!t.leftIsArray&&"object"===t.leftType){var e,r,i=t.options.propertyFilter;for(e in t.left)Object.prototype.hasOwnProperty.call(t.left,e)&&(i&&!i(e,t)||(r=new n(t.left[e],t.right[e]),t.push(r,e)));for(e in t.right)Object.prototype.hasOwnProperty.call(t.right,e)&&(i&&!i(e,t)||"undefined"==typeof t.left[e]&&(r=new n(void 0,t.right[e]),t.push(r,e)));return t.children&&0!==t.children.length?void t.exit():void t.setResult(void 0).exit()}};a.filterName="objects";var c=function(t){if(t.nested&&!t.delta._t){var e,r;for(e in t.delta)r=new i(t.left[e],t.delta[e]),t.push(r,e);t.exit()}};c.filterName="objects";var l=function(t){if(t&&t.children&&!t.delta._t){for(var e,r=t.children.length,n=0;n<r;n++)e=t.children[n],Object.prototype.hasOwnProperty.call(t.left,e.childName)&&void 0===e.result?delete t.left[e.childName]:t.left[e.childName]!==e.result&&(t.left[e.childName]=e.result);t.setResult(t.left).exit()}};l.filterName="collectChildren";var f=function(t){if(t.nested&&!t.delta._t){var e,r;for(e in t.delta)r=new o(t.delta[e]),t.push(r,e);t.exit()}};f.filterName="objects";var u=function(t){if(t&&t.children&&!t.delta._t){for(var e,r=t.children.length,n={},i=0;i<r;i++)e=t.children[i],n[e.childName]!==e.result&&(n[e.childName]=e.result);t.setResult(n).exit()}};u.filterName="collectChildren",r.collectChildrenDiffFilter=s,r.objectsDiffFilter=a,r.patchFilter=c,r.collectChildrenPatchFilter=l,r.reverseFilter=f,r.collectChildrenReverseFilter=u},{"../contexts/diff":4,"../contexts/patch":5,"../contexts/reverse":6}],14:[function(t,e,r){var n=2,i=60,o=null,s=function(e){if(!o){var r;if("undefined"!=typeof diff_match_patch)r="function"==typeof diff_match_patch?new diff_match_patch:new diff_match_patch.diff_match_patch;else if("function"==typeof t)try{var n="diff_match_patch_uncompressed",i=t("../../public/external/"+n);r=new i.diff_match_patch}catch(t){r=null}if(!r){if(!e)return null;var s=new Error("text diff_match_patch library not found");throw s.diff_match_patch_not_found=!0,s}o={diff:function(t,e){return r.patch_toText(r.patch_make(t,e))},patch:function(t,e){for(var n=r.patch_apply(r.patch_fromText(e),t),i=0;i<n[1].length;i++)if(!n[1][i]){var o=new Error("text patch failed");o.textPatchFailed=!0}return n[0]}}}return o},a=function(t){if("string"===t.leftType){var e=t.options&&t.options.textDiff&&t.options.textDiff.minLength||i;if(t.left.length<e||t.right.length<e)return void t.setResult([t.left,t.right]).exit();var r=s();if(!r)return void t.setResult([t.left,t.right]).exit();var o=r.diff;t.setResult([o(t.left,t.right),0,n]).exit()}};a.filterName="texts";var c=function(t){if(!t.nested&&t.delta[2]===n){var e=s(!0).patch;t.setResult(e(t.left,t.delta[0])).exit()}};c.filterName="texts";var l=function(t){var e,r,n,i,o,s,a,c,l=null,f=/^@@ +\-(\d+),(\d+) +\+(\d+),(\d+) +@@$/;for(n=t.split("\n"),e=0,r=n.length;e<r;e++){i=n[e];var u=i.slice(0,1);"@"===u?(l=f.exec(i),s=e,a=null,c=null,n[s]="@@ -"+l[3]+","+l[4]+" +"+l[1]+","+l[2]+" @@"):"+"===u?(a=e,n[e]="-"+n[e].slice(1),"+"===n[e-1].slice(0,1)&&(o=n[e],n[e]=n[e-1],n[e-1]=o)):"-"===u&&(c=e,n[e]="+"+n[e].slice(1))}return n.join("\n")},f=function(t){t.nested||t.delta[2]===n&&t.setResult([l(t.delta[0]),0,n]).exit()};f.filterName="texts",r.diffFilter=a,r.patchFilter=c,r.reverseFilter=f},{}],15:[function(t,e,r){var n="function"==typeof Array.isArray?Array.isArray:function(t){return t instanceof Array},i=function(t){if(t.left===t.right)return void t.setResult(void 0).exit();if("undefined"==typeof t.left){if("function"==typeof t.right)throw new Error("functions are not supported");return void t.setResult([t.right]).exit()}if("undefined"==typeof t.right)return void t.setResult([t.left,0,0]).exit();if("function"==typeof t.left||"function"==typeof t.right)throw new Error("functions are not supported");return t.leftType=null===t.left?"null":typeof t.left,t.rightType=null===t.right?"null":typeof t.right,t.leftType!==t.rightType?void t.setResult([t.left,t.right]).exit():"boolean"===t.leftType||"number"===t.leftType?void t.setResult([t.left,t.right]).exit():("object"===t.leftType&&(t.leftIsArray=n(t.left)),"object"===t.rightType&&(t.rightIsArray=n(t.right)),t.leftIsArray!==t.rightIsArray?void t.setResult([t.left,t.right]).exit():void 0)};i.filterName="trivial";var o=function(t){return"undefined"==typeof t.delta?void t.setResult(t.left).exit():(t.nested=!n(t.delta),t.nested?void 0:1===t.delta.length?void t.setResult(t.delta[0]).exit():2===t.delta.length?void t.setResult(t.delta[1]).exit():3===t.delta.length&&0===t.delta[2]?void t.setResult(void 0).exit():void 0)};o.filterName="trivial";var s=function(t){return"undefined"==typeof t.delta?void t.setResult(t.delta).exit():(t.nested=!n(t.delta),t.nested?void 0:1===t.delta.length?void t.setResult([t.delta[0],0,0]).exit():2===t.delta.length?void t.setResult([t.delta[1],t.delta[0]]).exit():3===t.delta.length&&0===t.delta[2]?void t.setResult([t.delta[0]]).exit():void 0)};s.filterName="trivial",r.diffFilter=i,r.patchFilter=o,r.reverseFilter=s},{}],16:[function(t,e,r){var n=t("./environment"),i=t("./diffpatcher").DiffPatcher;r.DiffPatcher=i,r.create=function(t){return new i(t)},r.dateReviver=t("./date-reviver");var o;if(r.diff=function(){return o||(o=new i),o.diff.apply(o,arguments)},r.patch=function(){return o||(o=new i),o.patch.apply(o,arguments)},r.unpatch=function(){return o||(o=new i),o.unpatch.apply(o,arguments)},r.reverse=function(){return o||(o=new i),o.reverse.apply(o,arguments)},n.isBrowser)r.homepage="{{package-homepage}}",r.version="{{package-version}}";else{var s="../package.json",a=t(s);r.homepage=a.homepage,r.version=a.version;var c="./formatters",l=t(c);r.formatters=l,r.console=l.console}},{"./date-reviver":7,"./diffpatcher":8,"./environment":9}],17:[function(t,e,r){var n=function(t){this.name=t,this.filters=[]};n.prototype.process=function(t){if(!this.processor)throw new Error("add this pipe to a processor before using it");for(var e=this.debug,r=this.filters.length,n=t,i=0;i<r;i++){var o=this.filters[i];if(e&&this.log("filter: "+o.filterName),o(n),"object"==typeof n&&n.exiting){n.exiting=!1;break}}!n.next&&this.resultCheck&&this.resultCheck(n)},n.prototype.log=function(t){console.log("[jsondiffpatch] "+this.name+" pipe, "+t)},n.prototype.append=function(){return this.filters.push.apply(this.filters,arguments),this},n.prototype.prepend=function(){return this.filters.unshift.apply(this.filters,arguments),this},n.prototype.indexOf=function(t){if(!t)throw new Error("a filter name is required");for(var e=0;e<this.filters.length;e++){var r=this.filters[e];if(r.filterName===t)return e}throw new Error("filter not found: "+t)},n.prototype.list=function(){for(var t=[],e=0;e<this.filters.length;e++){var r=this.filters[e];t.push(r.filterName)}return t},n.prototype.after=function(t){var e=this.indexOf(t),r=Array.prototype.slice.call(arguments,1);if(!r.length)throw new Error("a filter is required");return r.unshift(e+1,0),Array.prototype.splice.apply(this.filters,r),this},n.prototype.before=function(t){var e=this.indexOf(t),r=Array.prototype.slice.call(arguments,1);if(!r.length)throw new Error("a filter is required");return r.unshift(e,0),Array.prototype.splice.apply(this.filters,r),this},n.prototype.clear=function(){return this.filters.length=0,this},n.prototype.shouldHaveResult=function(t){if(t===!1)return void(this.resultCheck=null);if(!this.resultCheck){var e=this;return this.resultCheck=function(t){if(!t.hasResult){console.log(t);var r=new Error(e.name+" failed");throw r.noResult=!0,r}},this}},r.Pipe=n},{}],18:[function(t,e,r){var n=function(t){this.selfOptions=t||{},this.pipes={}};n.prototype.options=function(t){return t&&(this.selfOptions=t),this.selfOptions},n.prototype.pipe=function(t,e){if("string"==typeof t){if("undefined"==typeof e)return this.pipes[t];this.pipes[t]=e}if(t&&t.name){if(e=t,e.processor===this)return e;this.pipes[e.name]=e}return e.processor=this,e},n.prototype.process=function(t,e){var r=t;r.options=this.options();for(var n,i,o=e||t.pipe||"default";o;)"undefined"!=typeof r.nextAfterChildren&&(r.next=r.nextAfterChildren,r.nextAfterChildren=null),"string"==typeof o&&(o=this.pipe(o)),o.process(r),i=r,n=o,o=null,r&&r.next&&(r=r.next,o=i.nextPipe||r.pipe||n);return r.hasResult?r.result:void 0},r.Processor=n},{}],19:[function(t,e,r){function n(t,e,r){for(var n=-1,i=s(e),o=i.length;++n<o;){var a=i[n],c=t[a],l=r(c,e[a],a,t,e);(l===l?l===c:c!==c)&&(void 0!==c||a in t)||(t[a]=l)}return t}var i=t("lodash._baseassign"),o=t("lodash._createassigner"),s=t("lodash.keys"),a=o(function(t,e,r){return r?n(t,e,r):i(t,e)});e.exports=a},{"lodash._baseassign":20,"lodash._createassigner":22,"lodash.keys":26}],20:[function(t,e,r){function n(t,e){return null==e?t:i(e,o(e),t)}var i=t("lodash._basecopy"),o=t("lodash.keys");e.exports=n},{"lodash._basecopy":21,"lodash.keys":26}],21:[function(t,e,r){function n(t,e,r){r||(r={});for(var n=-1,i=e.length;++n<i;){var o=e[n];r[o]=t[o]}return r}e.exports=n},{}],22:[function(t,e,r){function n(t){return s(function(e,r){var n=-1,s=null==e?0:r.length,a=s>2?r[s-2]:void 0,c=s>2?r[2]:void 0,l=s>1?r[s-1]:void 0;for("function"==typeof a?(a=i(a,l,5),s-=2):(a="function"==typeof l?l:void 0,s-=a?1:0),c&&o(r[0],r[1],c)&&(a=s<3?void 0:a,s=1);++n<s;){var f=r[n];f&&t(e,f,a)}return e})}var i=t("lodash._bindcallback"),o=t("lodash._isiterateecall"),s=t("lodash.restparam");e.exports=n},{"lodash._bindcallback":23,"lodash._isiterateecall":24,"lodash.restparam":25}],23:[function(t,e,r){function n(t,e,r){if("function"!=typeof t)return i;if(void 0===e)return t;switch(r){case 1:return function(r){return t.call(e,r)};case 3:return function(r,n,i){return t.call(e,r,n,i)};case 4:return function(r,n,i,o){return t.call(e,r,n,i,o)};case 5:return function(r,n,i,o,s){return t.call(e,r,n,i,o,s)}}return function(){return t.apply(e,arguments)}}function i(t){return t}e.exports=n},{}],24:[function(t,e,r){function n(t){return function(e){return null==e?void 0:e[t]}}function i(t){return null!=t&&a(u(t))}function o(t,e){return t="number"==typeof t||l.test(t)?+t:-1,e=null==e?f:e,t>-1&&t%1==0&&t<e}function s(t,e,r){if(!c(r))return!1;var n=typeof e;if("number"==n?i(r)&&o(e,r.length):"string"==n&&e in r){var s=r[e];return t===t?t===s:s!==s}return!1}function a(t){return"number"==typeof t&&t>-1&&t%1==0&&t<=f}function c(t){var e=typeof t;return!!t&&("object"==e||"function"==e)}var l=/^\d+$/,f=9007199254740991,u=n("length");e.exports=s},{}],25:[function(t,e,r){function n(t,e){if("function"!=typeof t)throw new TypeError(i);return e=o(void 0===e?t.length-1:+e||0,0),function(){for(var r=arguments,n=-1,i=o(r.length-e,0),s=Array(i);++n<i;)s[n]=r[e+n];switch(e){case 0:return t.call(this,s);case 1:return t.call(this,r[0],s);case 2:return t.call(this,r[0],r[1],s)}var a=Array(e+1);for(n=-1;++n<e;)a[n]=r[n];return a[e]=s,t.apply(this,a)}}var i="Expected a function",o=Math.max;e.exports=n},{}],26:[function(t,e,r){function n(t){return function(e){return null==e?void 0:e[t]}}function i(t){return null!=t&&s(m(t))}function o(t,e){return t="number"==typeof t||p.test(t)?+t:-1,e=null==e?g:e,t>-1&&t%1==0&&t<e}function s(t){return"number"==typeof t&&t>-1&&t%1==0&&t<=g}function a(t){for(var e=l(t),r=e.length,n=r&&t.length,i=!!n&&s(n)&&(h(t)||u(t)),a=-1,c=[];++a<r;){var f=e[a];(i&&o(f,n)||v.call(t,f))&&c.push(f)}return c}function c(t){var e=typeof t;return!!t&&("object"==e||"function"==e)}function l(t){if(null==t)return[];c(t)||(t=Object(t));var e=t.length;e=e&&s(e)&&(h(t)||u(t))&&e||0;for(var r=t.constructor,n=-1,i="function"==typeof r&&r.prototype===t,a=Array(e),l=e>0;++n<e;)a[n]=n+"";for(var f in t)l&&o(f,e)||"constructor"==f&&(i||!v.call(t,f))||a.push(f);return a}var f=t("lodash._getnative"),u=t("lodash.isarguments"),h=t("lodash.isarray"),p=/^\d+$/,d=Object.prototype,v=d.hasOwnProperty,y=f(Object,"keys"),g=9007199254740991,m=n("length"),x=y?function(t){var e=null==t?void 0:t.constructor;return"function"==typeof e&&e.prototype===t||"function"!=typeof t&&i(t)?a(t):c(t)?y(t):[]}:a;e.exports=x},{"lodash._getnative":27,"lodash.isarguments":28,"lodash.isarray":29}],27:[function(t,e,r){function n(t){return!!t&&"object"==typeof t}function i(t,e){var r=null==t?void 0:t[e];return a(r)?r:void 0}function o(t){return s(t)&&p.call(t)==c}function s(t){var e=typeof t;return!!t&&("object"==e||"function"==e)}function a(t){return null!=t&&(o(t)?d.test(u.call(t)):n(t)&&l.test(t))}var c="[object Function]",l=/^\[object .+?Constructor\]$/,f=Object.prototype,u=Function.prototype.toString,h=f.hasOwnProperty,p=f.toString,d=RegExp("^"+u.call(h).replace(/[\\^$.*+?()[\]{}|]/g,"\\$&").replace(/hasOwnProperty|(function).*?(?=\\\()| for .+?(?=\\\])/g,"$1.*?")+"$");e.exports=i},{}],28:[function(t,e,r){function n(t){return o(t)&&v.call(t,"callee")&&(!g.call(t,"callee")||y.call(t)==u)}function i(t){return null!=t&&a(t.length)&&!s(t)}function o(t){return l(t)&&i(t)}function s(t){var e=c(t)?y.call(t):"";return e==h||e==p}function a(t){return"number"==typeof t&&t>-1&&t%1==0&&t<=f}function c(t){var e=typeof t;return!!t&&("object"==e||"function"==e)}function l(t){return!!t&&"object"==typeof t}var f=9007199254740991,u="[object Arguments]",h="[object Function]",p="[object GeneratorFunction]",d=Object.prototype,v=d.hasOwnProperty,y=d.toString,g=d.propertyIsEnumerable;e.exports=n},{}],29:[function(t,e,r){function n(t){return!!t&&"object"==typeof t}function i(t,e){var r=null==t?void 0:t[e];return c(r)?r:void 0}function o(t){return"number"==typeof t&&t>-1&&t%1==0&&t<=m}function s(t){return a(t)&&v.call(t)==f}function a(t){var e=typeof t;return!!t&&("object"==e||"function"==e)}function c(t){return null!=t&&(s(t)?y.test(p.call(t)):n(t)&&u.test(t))}var l="[object Array]",f="[object Function]",u=/^\[object .+?Constructor\]$/,h=Object.prototype,p=Function.prototype.toString,d=h.hasOwnProperty,v=h.toString,y=RegExp("^"+p.call(d).replace(/[\\^$.*+?()[\]{}|]/g,"\\$&").replace(/hasOwnProperty|(function).*?(?=\\\()| for .+?(?=\\\])/g,"$1.*?")+"$"),g=i(Array,"isArray"),m=9007199254740991,x=g||function(t){return n(t)&&o(t.length)&&v.call(t)==l};e.exports=x},{}],30:[function(t,e,r){var n=t("lodash._createwrapper"),i=t("lodash._replaceholders"),o=t("lodash.restparam"),s=1,a=32,c=o(function(t,e,r){var o=s;if(r.length){var l=i(r,c.placeholder);o|=a}return n(t,o,e,r,l)});c.placeholder={},e.exports=c},{"lodash._createwrapper":31,"lodash._replaceholders":33,"lodash.restparam":34}],31:[function(t,e,r){function n(t,e,r){var n=r.length;switch(n){case 0:return t.call(e);case 1:return t.call(e,r[0]);case 2:return t.call(e,r[0],r[1]);case 3:return t.call(e,r[0],r[1],r[2])}return t.apply(e,r)}function i(t,e){return t="number"==typeof t||U.test(t)?+t:-1,e=null==e?P:e,t>-1&&t%1==0&&t<e}function o(t,e){for(var r=-1,n=t.length,i=-1,o=[];++r<n;)t[r]===e&&(t[r]=T,o[++i]=r);return o}function s(t,e,r){for(var n=r.length,i=-1,o=z(t.length-n,0),s=-1,a=e.length,c=Array(a+o);++s<a;)c[s]=e[s];for(;++i<n;)c[r[i]]=t[i];for(;o--;)c[s++]=t[i++];return c}function a(t,e,r){for(var n=-1,i=r.length,o=-1,s=z(t.length-i,0),a=-1,c=e.length,l=Array(s+c);++o<s;)l[o]=t[o];for(var f=o;++a<c;)l[f+a]=e[a];for(;++n<i;)l[f+r[n]]=t[o++];return l}function c(t,e){var r=-1,n=t.length;for(e||(e=Array(n));++r<n;)e[r]=t[r];return e}function l(t,e,r){function n(){var e=this&&this!==_&&this instanceof n?o:t;return e.apply(i?r:this,arguments)}var i=e&b,o=f(t);return n}function f(t){return function(){var e=arguments;switch(e.length){case 0:return new t;case 1:return new t(e[0]);case 2:return new t(e[0],e[1]);case 3:return new t(e[0],e[1],e[2]);case 4:return new t(e[0],e[1],e[2],e[3]);case 5:return new t(e[0],e[1],e[2],e[3],e[4]);case 6:return new t(e[0],e[1],e[2],e[3],e[4],e[5]);case 7:return new t(e[0],e[1],e[2],e[3],e[4],e[5],e[6])}var r=G(t.prototype),n=t.apply(r,e);return m(n)?n:r}}function u(t,e,r){function i(){for(var a=arguments.length,c=a,l=Array(a),f=this&&this!==_&&this instanceof i?s:t,u=i.placeholder;c--;)l[c]=arguments[c];var p=a<3&&l[0]!==u&&l[a-1]!==u?[]:o(l,u);return a-=p.length,a<r?d(t,e,h,u,void 0,l,p,void 0,void 0,r-a):n(f,this,l)}var s=f(t);return i}function h(t,e,r,n,i,c,l,u,p,v){function g(){for(var b=arguments.length,C=b,R=Array(b);C--;)R[C]=arguments[C];if(n&&(R=s(R,n,i)),c&&(R=a(R,c,l)),j||F){var E=g.placeholder,A=o(R,E);if(b-=A.length,b<v)return d(t,e,h,E,r,R,A,u,p,v-b)}var V=x?r:this,D=w?V[t]:t;return u?R=y(R,u):N&&R.length>1&&R.reverse(),m&&p<R.length&&(R.length=p),this&&this!==_&&this instanceof g&&(D=O||f(D)),D.apply(V,R)}var m=e&A,x=e&b,w=e&C,j=e&R,F=e&E,N=e&V,O=w?void 0:f(t);return g}function p(t,e,r,i){function o(){for(var e=-1,c=arguments.length,l=-1,f=i.length,u=Array(f+c),h=this&&this!==_&&this instanceof o?a:t;++l<f;)u[l]=i[l];for(;c--;)u[l++]=arguments[++e];return n(h,s?r:this,u)}var s=e&b,a=f(t);return o}function d(t,e,r,n,i,o,s,a,l,f){var u=e&R,h=a?c(a):void 0,p=u?s:void 0,d=u?void 0:s,v=u?o:void 0,y=u?void 0:o;e|=u?F:N,e&=~(u?N:F),e&j||(e&=~(b|C));var g=r(t,e,i,v,p,y,d,h,l,f);return g.placeholder=n,g}function v(t,e,r,n,i,o,s,a){var c=e&C;if(!c&&"function"!=typeof t)throw new TypeError(O);var f=n?n.length:0;if(f||(e&=~(F|N),n=i=void 0),s=void 0===s?s:z(x(s),0),a=void 0===a?a:x(a),f-=i?i.length:0,e&N){var d=n,v=i;n=i=void 0}var y=[t,e,r,n,i,d,v,o,s,a];if(t=y[0],e=y[1],r=y[2],n=y[3],i=y[4],a=y[9]=null==y[9]?c?0:t.length:z(y[9]-f,0),!a&&e&(R|E)&&(e&=~(R|E)),e&&e!=b)g=e==R||e==E?u(t,e,a):e!=F&&e!=(b|F)||i.length?h.apply(void 0,y):p(t,e,r,n);else var g=l(t,e,r);return g}function y(t,e){for(var r=t.length,n=Q(e.length,r),o=c(t);n--;){var s=e[n];t[n]=i(s,r)?o[s]:void 0}return t}function g(t){var e=m(t)?W.call(t):"";return e==L||e==I}function m(t){var e=typeof t;return!!t&&("object"==e||"function"==e)}function x(t){if(!t)return 0===t?t:0;if(t=w(t),t===D||t===-D){var e=t<0?-1:1;return e*k}var r=t%1;return t===t?r?t-r:t:0}function w(t){if(m(t)){var e=g(t.valueOf)?t.valueOf():t;t=m(e)?e+"":e}if("string"!=typeof t)return 0===t?t:+t;t=t.replace($,"");var r=q.test(t);return r||H.test(t)?B(t.slice(2),r?2:8):M.test(t)?S:+t}var _=t("lodash._root"),b=1,C=2,j=4,R=8,E=16,F=32,N=64,A=128,V=512,O="Expected a function",D=1/0,P=9007199254740991,k=1.7976931348623157e308,S=NaN,T="__lodash_placeholder__",L="[object Function]",I="[object GeneratorFunction]",$=/^\s+|\s+$/g,M=/^[-+]0x[0-9a-f]+$/i,q=/^0b[01]+$/i,H=/^0o[0-7]+$/i,U=/^(?:0|[1-9]\d*)$/,B=parseInt,J=Object.prototype,W=J.toString,z=Math.max,Q=Math.min,G=function(){
function t(){}return function(e){if(m(e)){t.prototype=e;var r=new t;t.prototype=void 0}return r||{}}}();e.exports=v},{"lodash._root":32}],32:[function(t,e,r){(function(t){function n(t){return t&&t.Object===Object?t:null}var i={function:!0,object:!0},o=i[typeof r]&&r&&!r.nodeType?r:void 0,s=i[typeof e]&&e&&!e.nodeType?e:void 0,a=n(o&&s&&"object"==typeof t&&t),c=n(i[typeof self]&&self),l=n(i[typeof window]&&window),f=n(i[typeof this]&&this),u=a||l!==(f&&f.window)&&l||c||f||Function("return this")();e.exports=u}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}],33:[function(t,e,r){function n(t,e){for(var r=-1,n=t.length,o=-1,s=[];++r<n;)t[r]===e&&(t[r]=i,s[++o]=r);return s}var i="__lodash_placeholder__";e.exports=n},{}],34:[function(t,e,r){arguments[4][25][0].apply(r,arguments)},{dup:25}],35:[function(t,e,r){function n(t){return!!t&&"object"==typeof t}function i(t){return function(e){return null==e?void 0:e[t]}}function o(t){return null!=t&&s(d(t))}function s(t){return"number"==typeof t&&t>-1&&t%1==0&&t<=p}function a(t){return null==t||(o(t)&&(l(t)||u(t)||c(t)||n(t)&&f(t.splice))?!t.length:!h(t).length)}var c=t("lodash.isarguments"),l=t("lodash.isarray"),f=t("lodash.isfunction"),u=t("lodash.isstring"),h=t("lodash.keys"),p=9007199254740991,d=i("length");e.exports=a},{"lodash.isarguments":36,"lodash.isarray":37,"lodash.isfunction":38,"lodash.isstring":39,"lodash.keys":40}],36:[function(t,e,r){arguments[4][28][0].apply(r,arguments)},{dup:28}],37:[function(t,e,r){arguments[4][29][0].apply(r,arguments)},{dup:29}],38:[function(t,e,r){function n(t){var e=i(t)?c.call(t):"";return e==o||e==s}function i(t){var e=typeof t;return!!t&&("object"==e||"function"==e)}var o="[object Function]",s="[object GeneratorFunction]",a=Object.prototype,c=a.toString;e.exports=n},{}],39:[function(t,e,r){function n(t){return!!t&&"object"==typeof t}function i(t){return"string"==typeof t||n(t)&&a.call(t)==o}var o="[object String]",s=Object.prototype,a=s.toString;e.exports=i},{}],40:[function(t,e,r){arguments[4][26][0].apply(r,arguments)},{dup:26,"lodash._getnative":41,"lodash.isarguments":36,"lodash.isarray":37}],41:[function(t,e,r){arguments[4][27][0].apply(r,arguments)},{dup:27}],42:[function(t,e,r){var n=function(t){this.cache=t||{}};n.prototype.getData=function(t,e){var r=this.cache[t];r||(this.cache[t]={}),e(null,this.cache[t])},n.prototype.storeData=function(t,e,r){this.cache[t]=e,r&&r(null)},e.exports=n},{}],43:[function(t,e,r){var n,i=t("lodash.assign"),o=t("lodash.bind"),s=t("lodash.isempty"),a=t("events").EventEmitter,c=t("jsondiffpatch"),l=t("./commands"),f=t("./utils");n=function(t,e,r){if(!t)throw new Error("No socket specified");e||(e=""),r||(r={}),this.socket=t,this.room=e,this.syncing=!1,this.initialized=!1,this.scheduled=!1,this.doc={localVersion:0,serverVersion:0,shadow:{},localCopy:{},edits:[]},r=i({objectHash:function(t){return t.id||t._id||JSON.stringify(t)}},r),this.jsondiffpatch=c.create(r),a.call(this);var n,s=["_onConnected","syncWithServer","applyServerEdit","applyServerEdits","schedule","onRemoteUpdate"];for(var l in s)n=s[l],this[n]=o(this[n],this)},n.prototype=new a,n.prototype.getData=function(){return this.doc.localCopy},n.prototype.initialize=function(){this.syncing=!0,this.socket.emit(l.join,this.room,this._onConnected)},n.prototype._onConnected=function(t){this.syncing=!1,this.initialized=!0,this.doc.shadow=f.deepCopy(t),this.doc.localCopy=t,this.doc.serverVersion=0,this.socket.on(l.remoteUpdateIncoming,this.onRemoteUpdate),this.emit("connected")},n.prototype.onRemoteUpdate=function(t){this.socket.id!==t&&this.schedule()},n.prototype.schedule=function(){this.scheduled||(this.scheduled=!0,this.syncWithServer())},n.prototype.sync=function(){this.schedule()},n.prototype.syncWithServer=function(){if(this.syncing||!this.initialized)return!1;this.scheduled&&(this.scheduled=!1),this.syncing=!0;var t=this.createDiff(this.doc.shadow,this.doc.localCopy),e=this.doc.localVersion;s(t)||(this.doc.edits.push(this.createDiffMessage(t,e)),this.doc.localVersion++);var r=this.createEditMessage(e);return this.applyPatchTo(this.doc.shadow,f.deepCopy(t)),this.sendEdits(r),!0},n.prototype.createDiff=function(t,e){return this.jsondiffpatch.diff(t,e)},n.prototype.applyPatchTo=function(t,e){this.jsondiffpatch.patch(t,e)},n.prototype.createDiffMessage=function(t,e){return{serverVersion:this.doc.serverVersion,localVersion:e,diff:t}},n.prototype.createEditMessage=function(t){return{room:this.room,edits:this.doc.edits,localVersion:t,serverVersion:this.doc.serverVersion}},n.prototype.sendEdits=function(t){this.socket.emit(l.syncWithServer,t,this.applyServerEdits)},n.prototype.applyServerEdits=function(t){t&&t.localVersion===this.doc.localVersion?(this.doc.edits=[],t.edits.forEach(this.applyServerEdit)):this.emit("error","REJECTED_PATCH"),this.syncing=!1,this.emit("synced"),this.scheduled&&this.syncWithServer()},n.prototype.applyServerEdit=function(t){return t.localVersion===this.doc.localVersion&&t.serverVersion===this.doc.serverVersion&&(s(t.diff)||(this.applyPatchTo(this.doc.shadow,t.diff),this.doc.serverVersion++,this.applyPatchTo(this.doc.localCopy,f.deepCopy(t.diff))),!0)},e.exports=n},{"./commands":44,"./utils":46,events:1,jsondiffpatch:16,"lodash.assign":19,"lodash.bind":30,"lodash.isempty":35}],44:[function(t,e,r){e.exports={join:"diffsync-join",syncWithServer:"diffsync-send-edit",remoteUpdateIncoming:"diffsync-updated-doc",error:"diffsync-error"}},{}],45:[function(t,e,r){var n,i=t("lodash.assign"),o=t("lodash.bind"),s=t("lodash.isempty"),a=t("jsondiffpatch"),c=t("./commands"),l=t("./utils");n=function(t,e,r){if(!t||!e)throw new Error("Need to specify an adapter and a transport");r||(r={}),this.adapter=t,this.transport=e,this.data={},this.requests={},this.saveRequests={},this.saveQueue={},this.trackConnection=o(this.trackConnection,this),r=i({objectHash:function(t){return t.id||t._id||JSON.stringify(t)}},r),this.jsondiffpatch=a.create(r),this.transport.on("connection",this.trackConnection)},n.prototype.trackConnection=function(t){t.on(c.join,this.joinConnection.bind(this,t)),t.on(c.syncWithServer,this.receiveEdit.bind(this,t))},n.prototype.joinConnection=function(t,e,r){this.getData(e,function(n,i){t.join(e),i.clientVersions[t.id]={backup:{doc:l.deepCopy(i.serverCopy),serverVersion:0},shadow:{doc:l.deepCopy(i.serverCopy),serverVersion:0,localVersion:0},edits:[]},r(i.serverCopy)})},n.prototype.getData=function(t,e){var r=this.data[t],n=this.data,i=this.requests;r?e(null,r):i[t]?i[t]=!0:(i[t]=!0,this.adapter.getData(t,function(r,o){n[t]={registeredSockets:[],clientVersions:{},serverCopy:o},i[t]=!1,e(null,n[t])}))},n.prototype.receiveEdit=function(t,e,r){this.getData(e.room,function(n,i){var o=i.clientVersions[t.id];return n||!o?void t.emit(c.error,"Need to re-connect!"):(e.serverVersion===o.shadow.serverVersion&&(o.edits=[]),e.edits.forEach(function(t){t.serverVersion===o.shadow.serverVersion&&t.localVersion===o.shadow.localVersion?(o.backup.doc=l.deepCopy(o.shadow.doc),this.jsondiffpatch.patch(o.shadow.doc,l.deepCopy(t.diff)),this.jsondiffpatch.patch(i.serverCopy,l.deepCopy(t.diff)),s(t.diff)||o.shadow.localVersion++):console.log("error","patch rejected!!",t.serverVersion,"->",o.shadow.serverVersion,":",t.localVersion,"->",o.shadow.localVersion)}.bind(this)),this.saveSnapshot(e.room),e.edits.length>0&&this.transport.to(e.room).emit(c.remoteUpdateIncoming,t.id),void this.sendServerChanges(i,o,r))}.bind(this))},n.prototype.saveSnapshot=function(t){var e=!this.saveRequests[t],r=function(){var e=this.saveQueue[t]===!0;this.saveRequests[t]=!1,e&&(this.saveQueue[t]=!1,this.saveSnapshot(t))}.bind(this);e?(this.saveRequests[t]=!0,this.getData(t,function(e,n){!e&&n?this.adapter.storeData(t,n.serverCopy,r):r()}.bind(this))):this.saveQueue[t]=!0},n.prototype.sendServerChanges=function(t,e,r){var n=this.jsondiffpatch.diff(e.shadow.doc,t.serverCopy),i=e.shadow.serverVersion;s(n)||(e.edits.push({serverVersion:i,localVersion:e.shadow.localVersion,diff:n}),e.shadow.serverVersion++,this.jsondiffpatch.patch(e.shadow.doc,l.deepCopy(n))),r({localVersion:e.shadow.localVersion,serverVersion:i,edits:e.edits})},e.exports=n},{"./commands":44,"./utils":46,jsondiffpatch:16,"lodash.assign":19,"lodash.bind":30,"lodash.isempty":35}],46:[function(t,e,r){e.exports={deepCopy:function(t){return null===t||void 0===t?t:JSON.parse(JSON.stringify(t))}}},{}]},{},[2])(2)});